---
title: "Weekly survival by latitude, averaged across ROMS and taxa"
author: "A Fischbach"
date: "May 17, 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(RColorBrewer)
```

## Load the data  
The dat.frame df_ee was built by the .\rCode\03-weekly_survival-heat_map_by_latitude.R script, which summarized weekly survival into 1 degree latitudinal bands for all taxa, modeled across study years within each study period.
Each row of this dat.frame represents survival across weeks (columns 1:53) for each taxon, model, and year (indicated in the columns 'taxa', 'model', and 'year'). The column 'studyPeriodOne' is TRUE if year is part of the study period 2003-2012

```{r Read the data}
#baseDir <- 'D:/HelpingOthers/droghini/sea-invaders'
#load(file.path(baseDir, '/heatMap/week_survival_lat_taxa_model_studyPeriod.rData'))
load(file.path(baseDir, '/rOut/week_survival_lat_taxa_model_studyPeriod.rData'))
cat(nrow(df_ee), 'rows of data read in from', length(unique(df_ee$taxa)), 'taxa', fill =T)
glimpse(df_ee)
```

## Reshape the data into long form with a column for weeks, a column for latidudinal bands, and the columns for the taxa, model, year and study period.
```{r Reshape}
    df_tidy <- df_ee %>%
            gather(key = Week, value = survival, -taxa, -model, -studyPeriodOne, -lat, -year)
    df_tidy$Week <- as.numeric(substr(df_tidy$Week, start = 6, stop = 7))
    df_tidy$lat <- as.numeric(df_tidy$lat)
  glimpse(df_tidy)
  summary(df_tidy)
```

## Sumarize the data 
Summary plot of mean survival over all taxa by StudyPeriod (False = future, True = current) and latitudinal band.

Take the mean of weekly survival across each year within each study period.
If that mean is >= 0.7, classify the latitudinal band as having habitat (1, 0 otherwise).
This 7/10 threshold is the same threshold that was used to define year-round survival.

```{r Summarize data}
# Within a taxon-model-study period, and for each week:
# How many years are predicted to have suitable habitat?
  df_byPeriodModel <- df_tidy %>% 
    mutate(Period = as.integer(!studyPeriodOne) ) %>% 
    group_by(Period, taxa, Week, lat, model) %>% 
    summarize(nSurvival = sum(survival, na.rm = T))
  glimpse(df_byPeriodModel)
  summary(df_byPeriodModel)
```

```{r classify survival habitat for the latitude} 
# Is number of years >= 7?
  df_byPeriodModelClass <-df_byPeriodModel %>%
                          mutate(survival = if_else(nSurvival >= 7, 1, 0))
```

Average across the 3 ROMS models

```{r take the mean survival across models} 
  df_byPeriodTaxa <- df_byPeriodModelClass %>% 
    group_by(Period, taxa, Week, lat) %>% 
    summarize(MeanAcrossModelsSurvival = mean(survival, na.rm = T))
  glimpse(df_byPeriodTaxa)
  summary(df_byPeriodTaxa)
              
```

Summarize across taxa
```{r count survial across taxa}
  df_byPeriod <- df_byPeriodTaxa %>% 
               group_by(Period, Week, lat) %>% 
               summarize(speciesRichness = sum(MeanAcrossModelsSurvival, na.rm = T))
  glimpse(df_byPeriod)
  summary(df_byPeriod)

```
##Plot
For each week and degree of latitude within the Bering Sea shelf, depict the mean survival across taxa averaged across years and models during the two study periods.

Technical plotting issues:
1) Need to generate a meaningful time label on the x-axis (day of year, sensible grid lines every 1st day of every other month?)
2) Need a suitable plot grid to be in the foreground.  
Perhaps a thin green line may work with the viridis::plasma pallet.
3) Need to improve the legend text, and numeric labels #Done?
  
```{r plot}
  color.pal <- brewer.pal(11,"RdYlBu")[c(11,9,8,7,5,4,3,1)]
 #the.breaks<-c(-1,20,30,35,37,40,42)
the.breaks<-c(5,10,20,30,34,36,38,40,42) #no pixel predicted to have NIS < 5
  the.labels<-c("6 - 9","10 - 20", "20 - 29", "30 - 33","34 - 35", "36 - 37", "38 - 39", "40 - 42") #breaks are (inclusive,excluded] Starts at 5 but minimum NIS richness is 5.66 and I'm rounding up to nearest integer for legend clarity
  df_byPeriod %>% 
    mutate(spRichf=cut(speciesRichness,breaks=the.breaks)) %>%
    mutate(periodf=factor(Period,levels=c(0,1),labels=c("2003-2012","2030-2039"))) %>%
    subset(Week<53 & lat > 51) %>% 
    #subset to make the plot prettier
    #remove 53 weeks - doesn't happen every year so it's not out of 10 (removes right-most vertical band of no species richness across all latitudes)
    #remove latitude 51 (so few pixels that you end up getting little survival predicted)
    ggplot(aes(Week, lat, as.factor(spRichf))) + 
    geom_tile(aes(fill = as.factor(spRichf))) + 
   scale_fill_manual(values=color.pal,name="NIS Richness",labels=factor(the.labels)) +
    #scale_fill_manual(values=color.pal,name=factor(the.breaks)) +
    scale_y_continuous(breaks=seq(from=51,to=67,by=2),name="Latitude",expand=c(0,0))+
    scale_x_continuous(breaks=seq(from=0,to=50,by=10),name="Week of the Year")+
    theme_classic() +
    theme(legend.direction = "vertical",
        legend.title = element_text('NIS Richness'), 
         panel.spacing = unit(2, "lines"), #sets spacing between facet panels
         panel.grid.major = element_line(size = 0.5, colour = '#00441155')) +
    facet_wrap(~periodf)

#ggsave("plots/heatmap_weekly_survival.png", plot = last_plot(), width = 7, height = 4, units = "in",dpi = 300)
  #ran separately - ggsave not working inside RMarkdown?
```

Plot only current period (2003-2012)
```{r period_one_only}
  color.pal <- brewer.pal(11,"RdYlBu")[c(11,9,8,7,5,4,3,1)]
 #the.breaks<-c(-1,20,30,35,37,40,42)
the.breaks<-c(5,10,20,30,34,36,38,40,42) 
  the.labels<-c("6 - 9","10 - 20", "20 - 29", "30 - 33","34 - 35", "36 - 37", "38 - 39", "40 - 42")
  #breaks are (inclusive,excluded] Starts at 5 but minimum NIS richness is 5.66 and I'm rounding up to nearest integer for legend clarity
  df_byPeriod %>% 
    mutate(spRichf=cut(speciesRichness,breaks=the.breaks)) %>%
    mutate(periodf=factor(Period,levels=c(0,1),labels=c("2003-2012","2030-2039"))) %>%
    subset(Week<53 & lat > 51 & Period=="0") %>% 
    #subset to make the plot prettier
    #remove 53 weeks - doesn't happen every year so it's not out of 10 (removes right-most vertical band of no species richness across all latitudes)
    #remove latitude 51 (so few pixels that you end up getting little survival predicted)
    ggplot(aes(Week, lat, as.factor(spRichf))) + 
    geom_tile(aes(fill = as.factor(spRichf))) + 
   scale_fill_manual(values=color.pal,name="NIS Richness",labels=factor(the.labels)) +
    #scale_fill_manual(values=color.pal,name=factor(the.breaks)) +
    scale_y_continuous(breaks=seq(from=51,to=67,by=1),name="Latitude",expand=c(0,0))+
    scale_x_continuous(breaks=seq(from=0,to=50,by=10),name="Week of the Year")+
    theme_classic() +
    theme(legend.direction = "vertical",
        legend.title = element_text('NIS Richness'), 
         panel.spacing = unit(2, "lines"), #sets spacing between facet panels
         panel.grid.major = element_line(size = 0.5, colour = '#00441155')) 
    #facet_wrap(~periodf)
  
##ggsave("plots/heatmap_weekly_period1.png", plot = last_plot(), width = 6, height = 4, units = "in",dpi = 300)
```