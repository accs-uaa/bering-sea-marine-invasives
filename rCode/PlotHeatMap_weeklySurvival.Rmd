---
title: "HeatMapPlottingOfWeeklyVLatBandSurvial"
author: "A Fischbach"
date: "May 17, 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(viridis)
```

## Load the data  
The dat.frame df_ee was built by the .\rCode\HeatMap_weeklySurvival.r script, which georaphically summarized weekly survival into 1 degree latitudinal bands for all taxa, modeles across study years within each study period.

```{r Read the data}
  load("~/Rcode/sea-invaders/rData/week_survival_lat_taxa_model_studyPeriod.rData")
  cat(nrow(df_ee), 'rows of data read in from', length(unique(df_ee$taxa)), 'taxa', fill =T)
  glimpse(df_ee)
```

## Reshape the data into a column for weeks, a column for latidudinal bands, and the columns for the taxa, model and study period.
```{r Reshape}
    df_tidy <- df_ee %>%
            gather(key = Week, value = survival, -taxa, -model, -studyPeriodOne, -lat)
    df_tidy$Week <- as.numeric(substr(df_tidy$Week, start = 6, stop = 7))
    df_tidy$lat <- as.numeric(df_tidy$lat)
  glimpse(df_tidy)
  summary(df_tidy)
```

## Sumarize the data 
Summary plot of mean survial over all taxa by StudyPeriod (False = future, True = past) and average across models.
```{r Summarize data}
  df_byPeriodModel <- df_tidy %>% 
    mutate(Period = as.integer(!studyPeriodOne) ) %>% 
    group_by(Period, taxa, Week, lat, model) %>% 
    summarize(meanSurvival = mean(survival, na.rm = T))
  glimpse(df_byPeriodModel)
  summary(df_byPeriodModel)
  # Summarize across models
  df_byPeriod <- df_byPeriodModel %>% 
    group_by(Period, taxa, Week, lat) %>% 
    summarize(meanSurvival = mean(meanSurvival, na.rm = T))
  glimpse(df_byPeriod)
  summary(df_byPeriod)
              
```
##Draft Plot
  It depicts the mean survial across taxa averaged across years and models during the two study periods for each week and degree of latitude within the Bering Sea shelf.
  Remaining questions for this plot.
  ?Should we take the mean of each taxa across study years for each model, then take the mean across models for each taxa?
 
  Technical plotting issues:
  1) Need to generate a meaningful time label on the
    x-axis (day of year, sensible grid lines every 1st day of every other month?)
  2) Need a suitable plot grid to be in the foreground.  
  Perahaps a thin green line may work with the viridis::plasma pallet.
  3) Need to improve the ledged text, and numeric labels
  
  
```{r plot}
  df_byPeriod %>% 
  ggplot(aes(Week, lat, meanSurvival)) + geom_tile(aes(fill = meanSurvival)) + 
    theme_classic() +
    theme(legend.direction = "vertical",
        legend.title = element_text('Mean Weekly Survival \n across taxa'), 
         panel.grid.major = element_line(size = 1, colour = '#00441155')) +
   # scale_fill_gradient(low="white", high="blue") + 
    scale_fill_gradientn(colours = viridis::magma(256)) +
    facet_wrap(~Period)
```